# frozen_string_literal: true

require 'spec_helper'

RSpec.describe 'User with admin_vulnerability custom role', feature_category: :system_access do
  let_it_be(:user) { create(:user) }
  let_it_be(:project) { create(:project, :repository, :in_group) }
  let_it_be(:vulnerability) { create(:vulnerability, :with_finding, project: project) }

  before do
    stub_licensed_features(custom_roles: true, security_dashboard: true)

    group_member = create(:group_member, :guest, user: user, source: project.group)
    create(
      :member_role,
      :guest,
      admin_vulnerability: true,
      read_code: false,
      read_vulnerability: true,
      members: [group_member],
      namespace: project.group
    )
    sign_in(user)
  end

  describe Projects::Security::VulnerabilitiesController do
    describe "#new" do
      it 'user has access via a custom role' do
        get new_project_security_vulnerability_path(project)

        expect(response).to have_gitlab_http_status(:ok)
        expect(response.body).to have_text(
          format(s_('VulnerabilityManagement|Add vulnerability finding'))
        )
      end
    end
  end
end
